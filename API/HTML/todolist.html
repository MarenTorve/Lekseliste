<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=150, initial-scale=2, user-scalable=no">
  <title>Lekselister</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="/JavaScript/lib.js"></script>
  <script src="/JavaScript/libModal.js"></script>
  <script src="/JavaScript/libMenu.js"></script>
</head>
<body>
<div id="divMenu"></div>
<div class="container">
  <h2>Mine lekser</h2>
  <table border="0" style="border-spacing: 0; width: 100%">
    <thead style="text-align: left">
    <tr>
      <th class="hidden">Liste ID</th>
      <th class="hidden">Bruker ID</th>
      <th width="100%" >Beskrivelse</th>
      <th>Delt</th>
      <th colspan="2" >Rediger</th>
    </tr>
    </thead>
    <tbody id="htmlTBodyToDoList">
    </tbody>
  </table>
  <hr>
</div>
<div class="container">
  <label for="txtCaption" style="display: table-cell; width: 1px; white-space: nowrap;vertical-align: bottom">Ny liste:</label>
  <span style="display: table-cell; padding: 0 0 0 5px;vertical-align: bottom;width: 100%"><input type="text" id="txtCaption" style="width: 100%"></span>
  <span style="font-size: large; vertical-align: bottom;display: table-cell; padding: 0 0 0 5px" onclick="addNewList().then()">💾</span>
</div>
<div class="container">
  <h3>Lister jeg følger</h3>
  <table id="htmlTableShardToDoList" border="0" style="border-spacing: 0; width: 100%">
    <thead style="text-align: left">
    <tr>
      <th>Bruker</th>
      <th width="50%" >Beskrivelse</th>
      <th width="50%" >Delt</th>
      <th class="hidden">Liste ID</th>
      <th class="hidden">Bruker ID</th>
    </tr>
    </thead>
    <tbody id="htmlTBodySharedToDoList">
    </tbody>
  </table>
</div>
<template id="templateToDoListRow">
  <tr>
    <td class="hidden"></td>
    <td class="hidden"></td>
    <td style="cursor: pointer; color: green;"></td>
    <td></td>
    <td style="cursor: pointer;"></td>
    <td style="cursor: pointer;"></td>
  </tr>
</template>
<template id="templateSharedToDoListRow">
  <tr>
    <td></td>
    <td style="cursor: pointer; color: green;"></td>
    <td></td>
    <td class="hidden"></td>
    <td class="hidden"></td>
  </tr>
</template>
<template id="templateTableSharedToDoListItem">
  <td colspan="5">
    <table>
      <thead style="text-align: left">
      <tr>
        <th>Lekse</th>
        <th>Frist</th>
      </tr>
      </thead>
      <tbody id="htmlTBodySharedToDoListItem">
      </tbody>
    </table>
  </td>
</template>
<template id="templateSharedToDoListItemRow">
  <tr>
    <td></td>
    <td></td>
  </tr>
</template>

<script>
  const token = localStorage.getItem('token');
  const fdUserID = localStorage.getItem('fdUserID');
  let txtCaption;
  let htmlTBodyToDoList;
  let htmlTBodySharedToDoList;
  let htmlTableShardToDoList;

  window.onload = async function () {
    txtCaption = document.getElementById("txtCaption");
    htmlTBodyToDoList = document.getElementById("htmlTBodyToDoList");
    htmlTBodySharedToDoList = document.getElementById("htmlTBodySharedToDoList");
    htmlTableShardToDoList = document.getElementById("htmlTableShardToDoList");
    menu.addMenuItem(new TMenuItem("Min side", navUserPage));
    menu.addMenuItem(new TMenuItem("Logut", logout));
    document.getElementById("divMenu").appendChild(menu.asHTMLElement());

    await getListFromServer();
    await getSharedToDoList();
  };

  let isEdit = false;
  async function getListFromServer(){
    const data = {
      token: token,
      fdUserID: fdUserID,
    };

    const route = "/todolist/read";
    const result = await restAPI(RestAPIMethod.POST, route, data);
    if(Array.isArray(result) === true) {
      htmlTBodyToDoList.innerHTML = "";
      for(let i = 0; i < result.length; i++){
        const htmlRow = getTemplateContent("templateToDoListRow");
        const htmlTDs = htmlRow.querySelectorAll("td");
        htmlTDs[0].innerText = result[i].fdToDoListID.toString();
        htmlTDs[1].innerText = result[i].fdUserID.toString();
        htmlTDs[2].innerText = result[i].fdCaption;
        htmlTDs[2].onclick = function(){
          localStorage.setItem("fdToDoListID",result[i].fdToDoListID);
          localStorage.setItem("toDoListCaption",result[i].fdCaption);
          formLoadPage("/todolist/listitem",
            {token: token, fdToDoListID: result[i].fdToDoListID, fdUserID: fdUserID}
          );
        };
        const checkBox = document.createElement("input");
        checkBox.type = "checkbox";
        checkBox.onclick = function(){
          updateShared(result[i].fdToDoListID, checkBox).then();
        };
        checkBox.checked = result[i].fdShared;
        htmlTDs[3].appendChild(checkBox);
        htmlTDs[4].innerText = "🔧";
        htmlTDs[4].onclick = function(){
          if(isEdit){
            return;
          }
          htmlTDs[2].onclick = null;
          editRowItem(htmlTDs,result[i].fdToDoListID);
          isEdit=true;
        };
        htmlTDs[5].innerText = "❌";
        htmlTDs[5].onclick = function (){
          confirmDeleteRowItem(result[i]);
        };
        htmlTBodyToDoList.appendChild(htmlRow);
      }
      isEdit = false;
    }
  }
  async function getSharedToDoList(){
    const data = {
      token: token,
      fdUserID: fdUserID,
    };
    const route = "/todolist/readsharedtodolist";
    const result = await restAPI(RestAPIMethod.POST, route, data);
    if(Array.isArray(result) === true) {
      htmlTBodySharedToDoList.innerHTML = "";
      for (let i = 0; i < result.length; i++) {
        const htmlRow = getTemplateContent("templateSharedToDoListRow");
        const htmlTDs = htmlRow.querySelectorAll("td");
        htmlTDs[0].innerText = result[i].fdUserName;
        htmlTDs[1].innerText = result[i].fdCaption;
        htmlTDs[1].onclick = async function(){
          await getSharedToDoListItems(htmlTDs[1], result[i], i);
        };
        htmlTDs[2].innerText = result[i].fdSharedCaption;
        htmlTDs[3].innerText = result[i].fdToDoListID;
        htmlTDs[4].innerText = result[i].fdSharedUserID;
        htmlTBodySharedToDoList.appendChild(htmlRow);
      }
    }
  }

  async function getSharedToDoListItems(aTD, aSharedToDoList, aRowIndex){

    const htmlRow = htmlTableShardToDoList.rows[aRowIndex + 2];
    if(htmlRow.querySelector("#htmlTBodySharedToDoListItem") !== null){
      htmlTableShardToDoList.deleteRow(aRowIndex + 2);
      return;
    }

    const data = {
      token: token,
      fdToDoListID: aSharedToDoList.fdToDoListID,
      fdUserID: aSharedToDoList.fdSharedUserID
    };
    const route = "todolist/listitem/read";
    const result = await restAPI(RestAPIMethod.POST, route, data);
    if(Array.isArray(result) === true) {
      let htmlRow = htmlTableShardToDoList.insertRow(aRowIndex + 2);
      const htmlCell = getTemplateContent("templateTableSharedToDoListItem");
      htmlRow.appendChild(htmlCell);
      const htmlTBodySharedToDoListItem = htmlRow.querySelector("#htmlTBodySharedToDoListItem");
      htmlTBodySharedToDoListItem.innerHTML = "";
      for (let i = 0; i < result.length; i++) {
        const dateDue = new Date(result[i].fdDateDue);

        htmlRow = getTemplateContent("templateSharedToDoListItemRow");
        const htmlTDs = htmlRow.querySelectorAll("td");
        htmlTDs[0].innerText = result[i].fdCaption;
        htmlTDs[1].innerText = formatDateToLocal(dateDue);
        htmlTBodySharedToDoListItem.appendChild(htmlRow);
      }
    }
  }

  async function addNewList() {
    const data = {
      token: token,
      fdUserID: fdUserID,
      fdCaption: txtCaption.value
    };

    const route = "/todolist/create";
    const result = await restAPI(RestAPIMethod.POST, route, data);
    if(Array.isArray(result) === true) {
      getListFromServer().then();
    }
  }

  function editRowItem(aRow,aListID){
    const fdCaption = aRow[2].innerText;
    aRow[2].innerText = aRow[2].innerHTML = "";
    const htmlInput = document.createElement("input");
    htmlInput.type = "text";
    htmlInput.value = fdCaption;
    htmlInput.style.width="100%";
    aRow[2].appendChild(htmlInput);
    aRow[4].innerText = "✅";
    aRow[4].onclick = function () {
      postItemToServer(aListID, htmlInput.value).then();
    };
    aRow[5].innerText = "⛔";
    aRow[5].onclick = function () {
      getListFromServer().then();
    }
  }

  async function postItemToServer(aItemID, aCaption) {
    const data = {
      token: token,
      fdToDoListID: aItemID,
      fdUserID: fdUserID,
      fdCaption: aCaption
    };

    const route = "/todolist/update";
    const result = await restAPI(RestAPIMethod.POST, route, data);
    if(Array.isArray(result) === true) {
      getListFromServer().then();
    }
  }

  function confirmDeleteRowItem(aItemRow){
    let msg = "Vil du slette liste \"" + aItemRow.fdCaption + "\"\r\n";
    msg += "og alle elementene i denne listen?";
    const modal = new TModalWindow(msg,EModalState.Warning,EModalButtons.OkCancel);
    modal.showModal(
      async function(aButton){
        if(aButton === EModalButtons.Ok){
          deleteRowItem(aItemRow.fdToDoListID).then();
        }
      }
    );
  }

  async function deleteRowItem (aItemID){
    const data = {
      token: token,
      fdToDoListID: aItemID,
      fdUserID: fdUserID
    };

    const route = "/todolist/delete";
    const result = await restAPI(RestAPIMethod.POST, route, data);
    if(Array.isArray(result) === true) {
      getListFromServer().then();
    }
  }

  async function updateShared(aItemID, aCheckBox) {
    const data = {
      token: token,
      fdUserID: fdUserID,
      fdToDoListID: aItemID,
      fdShared: aCheckBox.checked
    };
    const route = "todolist/updateshared";
    const result = await restAPI(RestAPIMethod.POST,route, data);
    if(Array.isArray(result) === false){
      showError("Kunne ikke endre!");
    }
  }

</script>
</body>
</html>