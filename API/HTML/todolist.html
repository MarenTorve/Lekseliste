<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=150, initial-scale=2, user-scalable=no">
  <title>Lekselister</title>
  <script src="/JavaScript/lib.js"></script>
  <script src="/JavaScript/libModal.js"></script>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
<div class="container">
  <span style="color: blue; cursor: pointer" onclick="navToHome()">Hjem</span>
  <h2>Mine lekser</h2>
  <table border="0" style="border-spacing: 0; width: 100%">
    <thead style="text-align: left">
    <tr>
      <th class="hidden">Liste ID</th>
      <th class="hidden">Bruker ID</th>
      <th width="100%" >Beskrivelse</th>
      <th>Delt</th>
      <th colspan="2" >Rediger</th>
    </tr>
    </thead>
    <tbody id="htmlTBodyToDoList">
    </tbody>
  </table>
  <hr>
</div>

<div class="container">
  <label for="txtCaption" style="display: table-cell; width: 1px; white-space: nowrap;vertical-align: bottom">Ny liste:</label>
  <span style="display: table-cell; padding: 0 0 0 5px;vertical-align: bottom;width: 100%"><input type="text" id="txtCaption" style="width: 100%"></span>
  <span style="font-size: large; vertical-align: bottom;display: table-cell; padding: 0 0 0 5px" onclick="addNewList().then()">💾</span>
</div>
<template id="templateToDoListRow">
  <tr>
    <td class="hidden"></td>
    <td class="hidden"></td>
    <td style="cursor: pointer; color: green;"></td>
    <td></td>
    <td style="cursor: pointer;"></td>
    <td style="cursor: pointer;"></td>
  </tr>
</template>
<script>
  const token = localStorage.getItem('token');
  const fdUserID = localStorage.getItem('fdUserID');
  let txtCaption;
  let htmlTBodyToDoList;

  window.onload = function () {
    txtCaption = document.getElementById("txtCaption");
    htmlTBodyToDoList = document.getElementById("htmlTBodyToDoList");

    getListFromServer().then();
  };

  let isEdit = false;
  async function getListFromServer(){
    let data = {
      token: token,
      fdUserID: fdUserID,
    };

    let route = "/todolist/read";
    let json = await RestAPI(RestAPIMethod.POST, route, data);
    if(json !== null) {
      htmlTBodyToDoList.innerHTML = "";
      for(let i = 0; i < json.length; i++){
        let htmlRow = getTemplateContent("templateToDoListRow");
        const htmlTDs = htmlRow.querySelectorAll("td");
        htmlTDs[0].innerText = json[i].fdToDoListID.toString();
        htmlTDs[1].innerText = json[i].fdUserID.toString();
        htmlTDs[2].innerText = json[i].fdCaption;
        htmlTDs[2].onclick = function(){
          localStorage.setItem("fdToDoListID",json[i].fdToDoListID);
          localStorage.setItem("toDoListCaption",json[i].fdCaption);
          formLoadPage("/todolist/listitem",
            {token: token, fdToDoListID: json[i].fdToDoListID, fdUserID: fdUserID}
          );
        };
        const checkBox = document.createElement("input");
        checkBox.type = "checkbox";
        checkBox.onclick = function(){
          updateShared(json[i].fdToDoListID, checkBox).then();
        };
        checkBox.checked = json[i].fdShared;
        htmlTDs[3].appendChild(checkBox);
        htmlTDs[4].innerText = "🔧";
        htmlTDs[4].onclick = function(){
          if(isEdit){
            return;
          }
          htmlTDs[2].onclick = null;
          editRowItem(htmlTDs,json[i].fdToDoListID);
          isEdit=true;
        };
        htmlTDs[5].innerText = "❌";
        htmlTDs[5].onclick = function (){
          deleteRowItem(json[i].fdToDoListID).then();
        };
        htmlTBodyToDoList.appendChild(htmlRow);
      }
      isEdit = false;
    }
  }
  async function addNewList() {
    let data = {
      token: token,
      fdUserID: fdUserID,
      fdCaption: txtCaption.value
    };

    let route = "/todolist/create";
    let json = await RestAPI(RestAPIMethod.POST, route, data);
    if(json !== null) {
      getListFromServer().then();
    }
  }

  function editRowItem(aRow,aListID){
    const fdCaption = aRow[2].innerText;
    aRow[2].innerText = aRow[2].innerHTML = "";
    const htmlInput = document.createElement("input");
    htmlInput.type = "text";
    htmlInput.value = fdCaption;
    htmlInput.style.width="100%";
    aRow[2].appendChild(htmlInput);
    aRow[4].innerText = "✅";
    aRow[4].onclick = function () {
      postItemToServer(aListID, htmlInput.value).then();
    };
    aRow[5].innerText = "⛔";
    aRow[5].onclick = function () {
      getListFromServer().then();
    }
  }

  async function postItemToServer(aItemID, aCaption) {
    let data = {
      token: token,
      fdToDoListID: aItemID,
      fdUserID: fdUserID,
      fdCaption: aCaption
    };

    let route = "/todolist/update";
    let json = await RestAPI(RestAPIMethod.POST, route, data);
    if(json !== null) {
      getListFromServer().then();
    }
  }

  async function deleteRowItem (aItemID){
    let data = {
      token: token,
      fdToDoListID: aItemID,
      fdUserID: fdUserID
    };

    let route = "/todolist/delete";
    let json = await RestAPI(RestAPIMethod.POST, route, data);
    if(json !== null) {
      getListFromServer().then();
    }
  }

  async function updateShared(aItemID, aCheckBox) {
    const data = {
      token: token,
      fdUserID: fdUserID,
      fdToDoListID: aItemID,
      fdShared: aCheckBox.checked
    };
    const route = "todolist/updateshared";
    const json = await RestAPI(RestAPIMethod.POST, route, data);
    if(json === null){
      const modalWindow = new TModalWindow("Kunne ikke endre", EModalState.Error, EModalButtons.OK);
      modalWindow.showModal(null);
    }
  }

  function navToHome() {
    formLoadPage("/",
      {token: token, fdUserID: fdUserID}
    );
  }

</script>
</body>
</html>